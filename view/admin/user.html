<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Admin - User Management</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<script>
		tailwind.config = {
			theme: {
				extend: {
					colors: {
						primary: '#3B82F6',
						accent: '#F59E0B',
						grayBorder: '#E5E7EB',
						danger: '#DC2626',
						success: '#059669'
					}
				}
			}
		}
	</script>
	<link rel="stylesheet" href="../css/style.css" />
</head>
<body class="min-h-screen bg-gray-50">
	<div id="navbarMount"></div>
	<main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
		<section class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
			<div>
				<h2 class="text-2xl font-semibold text-gray-800">Users</h2>
				<p class="text-sm text-gray-600">Manage all registered platform accounts</p>
			</div>
			<div class="flex flex-col sm:flex-row gap-3">
				<div class="flex items-center bg-white rounded-lg border border-grayBorder px-3">
					<svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m21 21-4.35-4.35M11 19a8 8 0 1 1 0-16 8 8 0 0 1 0 16z"/></svg>
					<input id="searchEmail" type="text" placeholder="Search by email" class="px-2 py-2 outline-none text-sm w-56">
				</div>
				<button id="searchBtn" class="bg-primary text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600">Search</button>
				<a href="/admin/register" class="sm:hidden bg-primary text-white px-4 py-2 rounded-lg text-sm text-center">New Admin</a>
			</div>
		</section>

		<section class="bg-white border border-grayBorder rounded-xl shadow-sm overflow-hidden">
			<div class="overflow-x-auto">
				<table class="min-w-full text-left text-sm">
					<thead class="bg-gray-100 text-gray-700">
						<tr>
							<th class="px-4 py-3 font-medium">ID</th>
							<th class="px-4 py-3 font-medium">Email</th>
							<th class="px-4 py-3 font-medium">Name</th>
							<th class="px-4 py-3 font-medium">Admin</th>
							<th class="px-4 py-3 font-medium">Created</th>
							<th class="px-4 py-3 font-medium text-right">Actions</th>
						</tr>
					</thead>
					<tbody id="usersTableBody">
						<tr><td colspan="6" class="px-4 py-6 text-center text-gray-500">Loading users...</td></tr>
					</tbody>
				</table>
			</div>
			<div class="flex items-center justify-between p-4 border-t border-gray-100">
				<div class="text-xs text-gray-500" id="paginationInfo">--</div>
				<div class="flex items-center gap-2">
					<button id="prevPage" class="px-3 py-1.5 text-sm bg-gray-100 rounded disabled:opacity-40">Prev</button>
					<span id="currentPage" class="text-sm font-medium text-gray-700">1</span>
					<button id="nextPage" class="px-3 py-1.5 text-sm bg-gray-100 rounded disabled:opacity-40">Next</button>
				</div>
			</div>
		</section>

		<section class="text-xs text-gray-500">
			Note: Deleting a user is permanent and cannot be undone.
		</section>
	</main>
	<div id="footerMount"></div>

	<!-- Modal -->
	<div id="confirmModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
		<div class="bg-white rounded-xl p-6 w-full max-w-sm space-y-4">
			<h3 class="text-lg font-semibold text-gray-800">Confirm Deletion</h3>
			<p class="text-sm text-gray-600">Are you sure you want to delete this user? This action cannot be undone.</p>
			<div class="flex justify-end gap-3 pt-2">
				<button id="cancelDelete" class="px-4 py-2 text-sm bg-gray-100 rounded-lg hover:bg-gray-200">Cancel</button>
				<button id="confirmDelete" class="px-4 py-2 text-sm bg-danger text-white rounded-lg hover:bg-red-600">Delete</button>
			</div>
		</div>
	</div>

	<script src="../js/admin.js"></script>
	<script>
		// Initialize page when DOM is loaded
		document.addEventListener('DOMContentLoaded', async () => {
			// Use admin.js layout injection and admin authentication
			await injectAdminLayout('users');
			
			// Initialize page-specific functionality
			initUserPage();
		});

		// Page-specific initialization
		async function initUserPage(){
			// Ensure admin authentication before loading data
			const me = await ensureAdmin();
			if (me) {
				loadUsers(1);
			}
			
			// Bind event listeners (don't duplicate logout handlers - admin.js already handles them)
			document.getElementById('prevPage')?.addEventListener('click', ()=>{ if(currentPage>1) loadUsers(currentPage-1); });
			document.getElementById('nextPage')?.addEventListener('click', ()=>{ if(currentPage<totalPages) loadUsers(currentPage+1); });
			document.getElementById('searchBtn')?.addEventListener('click', searchByEmail);
			document.getElementById('searchEmail')?.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); searchByEmail(); }});
			document.getElementById('cancelDelete')?.addEventListener('click', hideModal);
			document.getElementById('confirmDelete')?.addEventListener('click', deleteUser);
		}

		let currentPage = 1;
		let totalPages = 1;
		let deletingUserId = null;

		function setText(id,val){ const el=document.getElementById(id); if(el) el.textContent=val; }

		async function ensureAdmin(){
			// Use adminRequireAuth from admin.js instead of custom implementation
			const me = await adminRequireAuth();
			return me; // adminRequireAuth handles redirect automatically
		}

		function formatDate(dt){
			if(!dt) return '—';
			try { return new Date(dt).toLocaleDateString(); } catch { return dt; }
		}

		function renderUsers(users){
			const tbody = document.getElementById('usersTableBody');
			if(!users.length){
				tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-6 text-center text-gray-500">No users found</td></tr>';
				return;
			}
			tbody.innerHTML = '';
			users.forEach(u=>{
				const tr = document.createElement('tr');
				tr.className='border-t border-gray-100 hover:bg-gray-50';
				tr.innerHTML = `
					<td class="px-4 py-3 text-gray-700">${u.id}</td>
					<td class="px-4 py-3 text-primary break-all">${u.email}</td>
					<td class="px-4 py-3 text-gray-700">${(u.first_name||'') + ' ' + (u.last_name||'')}</td>
					<td class="px-4 py-3">${u.is_admin ? '<span class="px-2 py-1 text-xs rounded bg-green-100 text-success font-medium">Yes</span>' : '<span class="px-2 py-1 text-xs rounded bg-gray-200 text-gray-700">No</span>'}</td>
					<td class="px-4 py-3 text-gray-600">${formatDate(u.created_at)}</td>
					<td class="px-4 py-3 text-right">
						<button data-id="${u.id}" class="deleteBtn text-danger hover:text-red-600 text-sm">Delete</button>
					</td>
				`;
				tbody.appendChild(tr);
			});
			bindDeleteButtons();
		}

		async function loadUsers(page=1){
			const perPage = 10;
			try{
				const data = await adminApi(`/users?page=${page}&per_page=${perPage}`);
				currentPage = data.page;
				totalPages = data.pages;
				renderUsers(data.users);
				setText('paginationInfo', `Showing page ${data.page} of ${data.pages} • Total users: ${data.total}`);
				document.getElementById('currentPage').textContent = data.page;
				document.getElementById('prevPage').disabled = currentPage <= 1;
				document.getElementById('nextPage').disabled = currentPage >= totalPages;
			}catch(e){
				const tbody = document.getElementById('usersTableBody');
				tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-6 text-center text-red-600">Failed to load users: ${e.message}</td></tr>`;
			}
		}

		async function searchByEmail(){
			const email = document.getElementById('searchEmail').value.trim();
			if(!email){
				loadUsers(1);
				return;
			}
			const tbody = document.getElementById('usersTableBody');
			tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-6 text-center text-gray-500">Searching...</td></tr>';
			try{
				const user = await adminApi(`/users/search/email/${encodeURIComponent(email)}`);
				renderUsers([user]);
				setText('paginationInfo', 'Search result');
				document.getElementById('prevPage').disabled = true;
				document.getElementById('nextPage').disabled = true;
			}catch(e){
				tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-6 text-center text-red-600">Not found</td></tr>`;
				setText('paginationInfo','No match');
			}
		}

		function bindDeleteButtons(){
			document.querySelectorAll('.deleteBtn').forEach(btn=>{
				btn.addEventListener('click', ()=>{
					deletingUserId = btn.getAttribute('data-id');
					showModal();
				});
			});
		}

		function showModal(){ document.getElementById('confirmModal').classList.remove('hidden'); }
		function hideModal(){ document.getElementById('confirmModal').classList.add('hidden'); deletingUserId=null; }

		async function deleteUser(){
			if(!deletingUserId) return;
			try{
				await adminApi(`/users/${deletingUserId}`, { method: 'DELETE' });
				hideModal();
				loadUsers(currentPage);
			}catch(e){
				alert('Delete failed: ' + e.message);
			}
		}
	</script>
</body>
</html>
