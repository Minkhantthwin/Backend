<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1.0" />
	<title>Admin - Region Management</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<script>
		tailwind.config = {
			theme: {
				extend: {
					colors: {
						primary:'#3B82F6', accent:'#F59E0B',
						danger:'#DC2626', success:'#059669', grayBorder:'#E5E7EB'
					}
				}
			}
		}
	</script>
	<link rel="stylesheet" href="../css/style.css" />
</head>
<body class="min-h-screen bg-gray-50">
	<div id="navbarMount"></div>

	<main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
		<section class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
			<div>
				<h2 class="text-2xl font-semibold text-gray-800">Regions</h2>
				<p class="text-sm text-gray-600">Manage geographic regions (countries)</p>
			</div>
			<div class="flex flex-col sm:flex-row gap-3">
				<div class="flex items-center bg-white rounded-lg border border-grayBorder px-3">
					<svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m21 21-4.35-4.35M11 19a8 8 0 1 1 0-16 8 8 0 0 1 0 16z"/></svg>
					<input id="searchRegion" type="text" placeholder="Search name or code" class="px-2 py-2 outline-none text-sm w-56">
				</div>
				<button id="searchBtn" class="bg-primary text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600">Search</button>
				<button id="clearSearchBtn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm hover:bg-gray-300">Clear</button>
				<button id="newRegionBtn" class="bg-accent text-white px-4 py-2 rounded-lg text-sm hover:bg-yellow-600">New Region</button>
			</div>
		</section>

		<section class="bg-white border border-grayBorder rounded-xl shadow-sm overflow-hidden">
			<div class="overflow-x-auto">
				<table class="min-w-full text-left text-sm">
					<thead class="bg-gray-100 text-gray-700">
						<tr>
							<th class="px-4 py-3 font-medium">ID</th>
							<th class="px-4 py-3 font-medium">Name</th>
							<th class="px-4 py-3 font-medium">Code</th>
							<th class="px-4 py-3 font-medium text-right">Actions</th>
						</tr>
					</thead>
					<tbody id="regionsTableBody">
						<tr><td colspan="4" class="px-4 py-6 text-center text-gray-500">Loading regions...</td></tr>
					</tbody>
				</table>
			</div>
			<div class="flex items-center justify-between p-4 border-t border-gray-100">
				<div class="text-xs text-gray-500" id="regionInfo">--</div>
				<div class="flex gap-2">
					<button id="prevPage" class="px-3 py-1.5 text-sm bg-gray-100 rounded disabled:opacity-40">Prev</button>
					<span id="currentPage" class="text-sm font-medium text-gray-700">1</span>
					<button id="nextPage" class="px-3 py-1.5 text-sm bg-gray-100 rounded disabled:opacity-40">Next</button>
				</div>
			</div>
		</section>

		<section class="text-xs text-gray-500">
			Note: Codes must be unique (e.g. USA, UK). Currently showing up to 100 items.
		</section>
	</main>

	<div id="footerMount"></div>

	<!-- Create/Edit Modal -->
	<div id="regionModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
		<div class="bg-white rounded-xl p-6 w-full max-w-sm space-y-5">
			<h3 id="regionModalTitle" class="text-lg font-semibold text-gray-800">New Region</h3>
			<div class="space-y-4">
				<div>
					<label for="regionName" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
					<input id="regionName" type="text" class="w-full px-3 py-2 border border-grayBorder rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-sm"/>
				</div>
				<div>
					<label for="regionCode" class="block text-sm font-medium text-gray-700 mb-1">Code (3 letters)</label>
					<input id="regionCode" maxlength="3" type="text" class="w-full px-3 py-2 border border-grayBorder rounded-lg focus:ring-2 focus:ring-primary focus:border-primary uppercase text-sm"/>
				</div>
				<p id="regionModalError" class="hidden text-xs text-danger"></p>
			</div>
			<div class="flex justify-end gap-3">
				<button id="cancelRegionBtn" class="px-4 py-2 text-sm bg-gray-100 rounded-lg hover:bg-gray-200">Cancel</button>
				<button id="saveRegionBtn" class="px-4 py-2 text-sm bg-primary text-white rounded-lg hover:bg-blue-600">Save</button>
			</div>
		</div>
	</div>

	<!-- Delete Confirm Modal -->
	<div id="deleteRegionModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
		<div class="bg-white rounded-xl p-6 w-full max-w-sm space-y-4">
			<h3 class="text-lg font-semibold text-gray-800">Delete Region</h3>
			<p class="text-sm text-gray-600">Are you sure you want to delete <span id="deleteRegionName" class="font-medium text-gray-800"></span>? This action cannot be undone.</p>
			<div class="flex justify-end gap-3 pt-2">
				<button id="cancelDeleteRegion" class="px-4 py-2 text-sm bg-gray-100 rounded-lg hover:bg-gray-200">Cancel</button>
				<button id="confirmDeleteRegion" class="px-4 py-2 text-sm bg-danger text-white rounded-lg hover:bg-red-600">Delete</button>
			</div>
		</div>
	</div>

	<script src="../js/admin.js"></script>
	<script>
		// Initialize page when DOM is loaded
		document.addEventListener('DOMContentLoaded', async () => {
			// Use admin.js layout injection and admin authentication
			await injectAdminLayout('regions');
			
			// Initialize page-specific functionality
			initRegionPage();
		});

		// Page-specific initialization
		async function initRegionPage(){
			// Ensure admin authentication before loading data
			const me = await adminRequireAuth();
			if (me) {
				loadRegions();
			}
			
			// Bind event listeners
			document.getElementById('searchBtn').addEventListener('click', performSearch);
			document.getElementById('clearSearchBtn').addEventListener('click', ()=>{
				document.getElementById('searchRegion').value='';
				loadRegions();
			});
			document.getElementById('searchRegion').addEventListener('keydown', e=>{
				if(e.key==='Enter'){ e.preventDefault(); performSearch(); }
			});
			document.getElementById('newRegionBtn').addEventListener('click', openCreate);
			document.getElementById('cancelRegionBtn').addEventListener('click', closeRegionModal);
			document.getElementById('saveRegionBtn').addEventListener('click', saveRegion);
			document.getElementById('cancelDeleteRegion').addEventListener('click', closeDeleteModal);
			document.getElementById('confirmDeleteRegion').addEventListener('click', deleteRegion);
			document.getElementById('prevPage').addEventListener('click', ()=>{ if(currentPage>1){ currentPage--; renderRegions(); }});
			document.getElementById('nextPage').addEventListener('click', ()=>{ if(currentPage*pageSize<regions.length){ currentPage++; renderRegions(); }});
		}

		// State
		let regions = [];
		let currentPage = 1;
		const pageSize = 20;
		let editingRegionId = null;
		let deletingRegionId = null;
		let fullLoaded = false;

		function paginate(list){
			const start=(currentPage-1)*pageSize;
			return list.slice(start,start+pageSize);
		}

		function updatePaginationInfo(){
			const total = regions.length;
			const totalPages = Math.max(1, Math.ceil(total / pageSize));
			if(currentPage>totalPages){ currentPage=totalPages; }
			document.getElementById('currentPage').textContent = currentPage;
			document.getElementById('prevPage').disabled = currentPage<=1;
			document.getElementById('nextPage').disabled = currentPage>=totalPages;
			const info = total ? `Showing ${(currentPage-1)*pageSize+1}-${Math.min(currentPage*pageSize,total)} of ${total}${fullLoaded? '' : ' (partial list)'}` : 'No regions';
			document.getElementById('regionInfo').textContent = info;
		}

		function renderRegions(){
			const tbody = document.getElementById('regionsTableBody');
			if(!regions.length){
				tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-6 text-center text-gray-500">No regions found</td></tr>';
				updatePaginationInfo();
				return;
			}
			const slice = paginate(regions);
			tbody.innerHTML = '';
			slice.forEach(r=>{
				const tr = document.createElement('tr');
				tr.className='border-t border-gray-100 hover:bg-gray-50';
				tr.innerHTML = `
					<td class="px-4 py-3 text-gray-700">${r.id}</td>
					<td class="px-4 py-3 text-gray-800">${r.name}</td>
					<td class="px-4 py-3 font-mono text-gray-700">${r.code}</td>
					<td class="px-4 py-3 text-right space-x-3">
						<button data-edit="${r.id}" class="text-primary hover:underline text-sm">Edit</button>
						<button data-del="${r.id}" class="text-danger hover:underline text-sm">Delete</button>
					</td>`;
				tbody.appendChild(tr);
			});
			tbody.querySelectorAll('[data-edit]').forEach(btn=>{
				btn.addEventListener('click', ()=>openEdit(btn.getAttribute('data-edit')));
			});
			tbody.querySelectorAll('[data-del]').forEach(btn=>{
				btn.addEventListener('click', ()=>openDelete(btn.getAttribute('data-del')));
			});
			updatePaginationInfo();
		}

		async function loadRegions(){
			try{
				const data = await adminApi('/regions?page=1&per_page=100');
				regions = data;
				fullLoaded = regions.length < 100; // crude indicator
				currentPage = 1;
				renderRegions();
			}catch(e){
				document.getElementById('regionsTableBody').innerHTML =
					`<tr><td colspan="4" class="px-4 py-6 text-center text-red-600">Failed to load regions: ${e.message}</td></tr>`;
			}
		}

		async function performSearch(){
			const q = document.getElementById('searchRegion').value.trim();
			if(!q){
				await loadRegions();
				return;
			}
			document.getElementById('regionsTableBody').innerHTML =
				'<tr><td colspan="4" class="px-4 py-6 text-center text-gray-500">Searching...</td></tr>';
			try{
				const res = await adminApi(`/regions/search?query=${encodeURIComponent(q)}`);
				regions = res;
				currentPage=1;
				fullLoaded=true;
				renderRegions();
			}catch(e){
				document.getElementById('regionsTableBody').innerHTML =
					`<tr><td colspan="4" class="px-4 py-6 text-center text-red-600">Search failed: ${e.message}</td></tr>`;
			}
		}

		// Modal helpers
		function openCreate(){
			editingRegionId = null;
			document.getElementById('regionModalTitle').textContent = 'New Region';
			document.getElementById('regionName').value = '';
			document.getElementById('regionCode').value = '';
			document.getElementById('regionModalError').classList.add('hidden');
			document.getElementById('regionModal').classList.remove('hidden');
		}
		function openEdit(id){
			const r = regions.find(x=>String(x.id)===String(id));
			if(!r) return;
			editingRegionId = r.id;
			document.getElementById('regionModalTitle').textContent = 'Edit Region';
			document.getElementById('regionName').value = r.name;
			document.getElementById('regionCode').value = r.code;
			document.getElementById('regionModalError').classList.add('hidden');
			document.getElementById('regionModal').classList.remove('hidden');
		}
		function closeRegionModal(){
			document.getElementById('regionModal').classList.add('hidden');
		}
		function openDelete(id){
			const r = regions.find(x=>String(x.id)===String(id));
			if(!r) return;
			deletingRegionId = r.id;
			document.getElementById('deleteRegionName').textContent = `${r.name} (${r.code})`;
			document.getElementById('deleteRegionModal').classList.remove('hidden');
		}
		function closeDeleteModal(){
			deletingRegionId=null;
			document.getElementById('deleteRegionModal').classList.add('hidden');
		}

		async function saveRegion(){
			const name = document.getElementById('regionName').value.trim();
			const code = document.getElementById('regionCode').value.trim().toUpperCase();
			const errEl = document.getElementById('regionModalError');
			if(!name || !code){
				errEl.textContent = 'Name and code are required';
				errEl.classList.remove('hidden');
				return;
			}
			if(code.length>3){
				errEl.textContent = 'Code must be max 3 characters';
				errEl.classList.remove('hidden');
				return;
			}
			errEl.classList.add('hidden');
			try{
				if(editingRegionId){
					await adminApi(`/regions/${editingRegionId}`, {
						method:'PUT',
						body: JSON.stringify({ name, code })
					});
				}else{
					await adminApi('/regions', {
						method:'POST',
						body: JSON.stringify({ name, code })
					});
				}
				closeRegionModal();
				await loadRegions();
			}catch(e){
				errEl.textContent = e.message || 'Save failed';
				errEl.classList.remove('hidden');
			}
		}

		async function deleteRegion(){
			if(!deletingRegionId) return;
			try{
				await adminApi(`/regions/${deletingRegionId}`, { method:'DELETE' });
				closeDeleteModal();
				await loadRegions();
			}catch(e){
				alert('Delete failed: ' + e.message);
			}
		}
	</script>
</body>
</html>
